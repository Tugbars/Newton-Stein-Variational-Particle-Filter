<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVPF Optimization Journey: From 0.68 to 0.43 RMSE</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-code: #1e252e;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-orange: #d29922;
            --accent-purple: #a371f7;
            --border: #30363d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.7;
            padding: 2rem;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Header */
        .hero {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(135deg, #1a1f35 0%, #0d1117 100%);
            border-radius: 16px;
            margin-bottom: 3rem;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2358a6ff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .hero h1 {
            font-size: 2.8rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }

        .hero .subtitle {
            font-size: 1.3rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 3rem;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .stat-box {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .stat-value.before { color: var(--accent-red); }
        .stat-value.after { color: var(--accent-green); }
        .stat-value.improvement { color: var(--accent-blue); }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Section styling */
        section {
            margin-bottom: 4rem;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        h2 .step-number {
            background: var(--accent-blue);
            color: var(--bg-dark);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
        }

        h3 {
            font-size: 1.3rem;
            margin: 1.5rem 0 1rem;
            color: var(--accent-blue);
        }

        p {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--accent-blue);
        }

        /* Code blocks */
        pre {
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            margin: 1rem 0;
        }

        code {
            font-family: 'Fira Code', 'Consolas', monospace;
            background: var(--bg-code);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .keyword { color: #ff7b72; }
        .function { color: #d2a8ff; }
        .string { color: #a5d6ff; }
        .comment { color: #8b949e; }
        .number { color: #79c0ff; }

        /* Math formulas */
        .formula {
            background: var(--bg-code);
            border-left: 4px solid var(--accent-purple);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
            font-family: 'Georgia', serif;
            font-size: 1.1rem;
            overflow-x: auto;
        }

        .formula-label {
            color: var(--accent-purple);
            font-size: 0.85rem;
            font-family: sans-serif;
            margin-bottom: 0.5rem;
        }

        /* Result boxes */
        .result-box {
            display: flex;
            align-items: center;
            gap: 2rem;
            background: linear-gradient(135deg, rgba(63, 185, 80, 0.1) 0%, rgba(88, 166, 255, 0.1) 100%);
            border: 1px solid var(--accent-green);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .result-box .metric {
            text-align: center;
        }

        .result-box .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-green);
        }

        .result-box .metric-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Problem/Solution boxes */
        .problem-box {
            background: rgba(248, 81, 73, 0.1);
            border-left: 4px solid var(--accent-red);
            padding: 1rem 1.5rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .problem-box::before {
            content: '‚ö†Ô∏è The Problem';
            display: block;
            font-weight: 600;
            color: var(--accent-red);
            margin-bottom: 0.5rem;
        }

        .solution-box {
            background: rgba(63, 185, 80, 0.1);
            border-left: 4px solid var(--accent-green);
            padding: 1rem 1.5rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .solution-box::before {
            content: '‚úÖ The Solution';
            display: block;
            font-weight: 600;
            color: var(--accent-green);
            margin-bottom: 0.5rem;
        }

        .insight-box {
            background: rgba(163, 113, 247, 0.1);
            border-left: 4px solid var(--accent-purple);
            padding: 1rem 1.5rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .insight-box::before {
            content: 'üí° Key Insight';
            display: block;
            font-weight: 600;
            color: var(--accent-purple);
            margin-bottom: 0.5rem;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-code);
            color: var(--accent-blue);
            font-weight: 600;
        }

        tr:hover {
            background: rgba(88, 166, 255, 0.05);
        }

        .improvement-positive {
            color: var(--accent-green);
        }

        .improvement-negative {
            color: var(--accent-red);
        }

        /* Visual diagrams */
        .diagram {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
        }

        .diagram-title {
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--accent-blue);
        }

        /* Particle animation */
        .particle-container {
            position: relative;
            height: 200px;
            background: linear-gradient(90deg, rgba(248, 81, 73, 0.1) 0%, rgba(63, 185, 80, 0.1) 100%);
            border-radius: 8px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-blue);
        }

        .target-region {
            position: absolute;
            right: 10%;
            top: 20%;
            width: 80px;
            height: 120px;
            border: 2px dashed var(--accent-green);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-green);
            font-size: 0.8rem;
        }

        /* Gradient visualization */
        .gradient-viz {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 150px;
            padding: 1rem;
            gap: 0.5rem;
        }

        .gradient-bar {
            width: 40px;
            background: var(--accent-blue);
            border-radius: 4px 4px 0 0;
            transition: height 0.3s ease;
            position: relative;
        }

        .gradient-bar::after {
            content: attr(data-label);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        /* Flow diagram */
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            padding: 1rem;
        }

        .flow-box {
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            text-align: center;
            min-width: 120px;
        }

        .flow-arrow {
            color: var(--accent-blue);
            font-size: 1.5rem;
        }

        /* Comparison side by side */
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        @media (max-width: 768px) {
            .comparison {
                grid-template-columns: 1fr;
            }
        }

        .comparison-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .comparison-item.wrong {
            border-color: var(--accent-red);
        }

        .comparison-item.correct {
            border-color: var(--accent-green);
        }

        .comparison-item h4 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .comparison-item.wrong h4 { color: var(--accent-red); }
        .comparison-item.correct h4 { color: var(--accent-green); }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .timeline-item {
            position: relative;
            padding-bottom: 2rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-blue);
            border: 2px solid var(--bg-dark);
        }

        .timeline-item .time {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .timeline-item .title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .timeline-item .result {
            color: var(--accent-green);
            font-size: 0.9rem;
        }

        /* Animation keyframes */
        @keyframes particleMove {
            0% { transform: translateX(0); }
            100% { transform: translateX(calc(100% - 20px)); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Volcano visualization */
        .volcano-container {
            position: relative;
            height: 200px;
            margin: 1rem 0;
        }

        .volcano-svg {
            width: 100%;
            height: 100%;
        }

        /* Interactive elements */
        .toggle-details {
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            color: var(--accent-blue);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
        }

        .toggle-details:hover {
            background: var(--bg-card);
        }

        .details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .details-content.open {
            max-height: 2000px;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 4rem;
        }

        .pizza-celebration {
            font-size: 3rem;
            animation: pulse 1s ease-in-out infinite;
        }

        /* Summary cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }

        .summary-card .label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .summary-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-blue);
        }

        .summary-card.highlight {
            border-color: var(--accent-green);
            background: rgba(63, 185, 80, 0.1);
        }

        .summary-card.highlight .value {
            color: var(--accent-green);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Hero Section -->
        <header class="hero">
            <h1>SVPF Optimization Journey</h1>
            <p class="subtitle">Closing the gap with HCRBPF through principled mathematical fixes</p>
            <div class="hero-stats">
                <div class="stat-box">
                    <div class="stat-value before">0.68</div>
                    <div class="stat-label">Starting RMSE</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value after">0.4332</div>
                    <div class="stat-label">Final RMSE</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value improvement">-36%</div>
                    <div class="stat-label">Improvement</div>
                </div>
            </div>
        </header>

        <!-- Introduction -->
        <section id="intro">
            <h2>The Challenge</h2>
            
            <p>
                <strong>Stein Variational Particle Filtering (SVPF)</strong> is a powerful approach to sequential Bayesian inference
                that uses Stein Variational Gradient Descent to transport particles toward the posterior distribution. Unlike
                traditional particle filters that use resampling (which causes sample impoverishment), SVPF uses smooth
                deterministic transport guided by the geometry of the target distribution.
            </p>

            <p>
                Our benchmark was the <strong>Hierarchical Continuous Rao-Blackwellized Particle Filter (HCRBPF)</strong>, which
                achieves approximately <strong>0.41 RMSE</strong> on its optimal test case. HCRBPF has a significant advantage:
                it knows the exact mapping from a latent state <code>z</code> to the stochastic volatility parameters
                (œÅ, Œº, œÉ). SVPF doesn't have access to <code>z</code> ‚Äî it must infer everything from observations alone.
            </p>

            <div class="card">
                <div class="card-header">üìä The Data Generating Process (DGP)</div>
                <p>The DGP uses HCRBPF's z ‚Üí parameter mapping:</p>
                <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                    <li><code>z_t</code> follows an OU process (latent state)</li>
                    <li><code>Œ∏(z), Œº(z), œÉ(z)</code> computed via saturating functions</li>
                    <li><code>h_t = (1-Œ∏)¬∑h_{t-1} + Œ∏¬∑Œº + œÉ¬∑Œµ</code> (log-volatility)</li>
                    <li><code>r_t = exp(h/2) ¬∑ Œ∑</code> where <code>Œ∑ ~ Student-t(ŒΩ=5)</code></li>
                </ul>
                <p style="color: var(--accent-orange);">
                    <strong>‚ö†Ô∏è Model Misspecification:</strong> SVPF assumes fixed (œÅ, Œº, œÉ), but the true DGP has z-dependent parameters.
                    This is an inherent disadvantage we must work around.
                </p>
            </div>

            <div class="insight-box">
                The goal wasn't just to "tune hyperparameters" ‚Äî it was to identify and fix fundamental mathematical 
                errors in the SVPF implementation, then add principled enhancements that respect the structure of the problem.
            </div>
        </section>

        <!-- Step 1: Mixture Prior -->
        <section id="step1">
            <h2><span class="step-number">1</span> The O(N¬≤) Mixture Prior Gradient</h2>

            <div class="problem-box">
                The original implementation computed the prior gradient <em>per-particle</em>: each particle only considered
                its own previous position. This is mathematically incorrect. The SVPF paper (Eq. 6) specifies that the prior
                is a <strong>Gaussian mixture</strong> over ALL previous particles.
            </div>

            <h3>Why This Matters</h3>
            <p>
                In particle filtering, after the predict step, we don't know which previous particle "spawned" which current particle.
                The prior probability of a current particle <code>h</code> should account for <em>all</em> possible origins:
            </p>

            <div class="formula">
                <div class="formula-label">Correct Mixture Prior (Paper Eq. 6)</div>
                p(h_{t+1} | Z_t) = (1/N) ¬∑ Œ£·µ¢ p(h_{t+1} | h_t^i) = (1/N) ¬∑ Œ£·µ¢ N(h; Œº·µ¢, œÉ_z¬≤)
            </div>

            <p>where <code>Œº·µ¢ = Œº + œÅ(h_prev^i - Œº)</code> is the mean from each previous particle.</p>

            <div class="comparison">
                <div class="comparison-item wrong">
                    <h4>‚ùå Wrong: Per-Particle Prior</h4>
                    <pre><span class="comment">// Each particle only looks at itself</span>
<span class="keyword">float</span> mean_i = mu + rho * (h_prev[i] - mu);
grad[i] = -(h[i] - mean_i) / sigma_sq;</pre>
                    <p>Complexity: O(N)</p>
                    <p>This ignores the mixture structure entirely.</p>
                </div>
                <div class="comparison-item correct">
                    <h4>‚úÖ Correct: Mixture Prior</h4>
                    <pre><span class="comment">// Sum over ALL previous particles</span>
<span class="keyword">float</span> grad = <span class="number">0.0f</span>;
<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j < n; j++) {
    <span class="keyword">float</span> mean_j = mu + rho * (h_prev[j] - mu);
    <span class="keyword">float</span> r_j = responsibility(h[i], mean_j);
    grad += r_j * (-(h[i] - mean_j) / sigma_sq);
}</pre>
                    <p>Complexity: O(N¬≤)</p>
                    <p>Proper Gaussian mixture gradient.</p>
                </div>
            </div>

            <h3>The Responsibility Weights</h3>
            <p>
                The key insight is that each previous particle contributes to the gradient proportionally to how likely
                it is to have "generated" the current particle. This is the <strong>responsibility</strong>:
            </p>

            <div class="formula">
                <div class="formula-label">Responsibility Weight</div>
                r_j(h) = p(h | h_prev^j) / Œ£_k p(h | h_prev^k)
            </div>

            <p>
                Implemented with log-space arithmetic for numerical stability (log-sum-exp trick):
            </p>

            <pre><span class="comment">// Compute log-probabilities</span>
<span class="keyword">float</span> log_probs[N];
<span class="keyword">float</span> max_log = -INFINITY;
<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j < n; j++) {
    <span class="keyword">float</span> mean_j = mu + rho * (h_prev[j] - mu);
    <span class="keyword">float</span> diff = h_i - mean_j;
    log_probs[j] = -<span class="number">0.5f</span> * diff * diff / sigma_sq;
    max_log = fmaxf(max_log, log_probs[j]);
}

<span class="comment">// Log-sum-exp for normalization</span>
<span class="keyword">float</span> sum_exp = <span class="number">0.0f</span>;
<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j < n; j++) {
    sum_exp += expf(log_probs[j] - max_log);
}
<span class="keyword">float</span> log_norm = max_log + logf(sum_exp);

<span class="comment">// Weighted gradient</span>
<span class="keyword">float</span> grad = <span class="number">0.0f</span>;
<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j < n; j++) {
    <span class="keyword">float</span> r_j = expf(log_probs[j] - log_norm);
    <span class="keyword">float</span> mean_j = mu + rho * (h_prev[j] - mu);
    grad += r_j * (-(h_i - mean_j) / sigma_sq);
}</pre>

            <div class="result-box">
                <div class="metric">
                    <div class="metric-value">0.68 ‚Üí 0.46</div>
                    <div class="metric-label">RMSE Improvement</div>
                </div>
                <div style="flex: 1;">
                    <p><strong>Impact:</strong> This single fix reduced the gap from 66% to 12%. The mixture prior properly 
                    accounts for uncertainty about particle ancestry, giving the gradient the correct "softness" that prevents
                    particles from being too confident about where they came from.</p>
                </div>
            </div>
        </section>

        <!-- Step 2: Log-Squared Likelihood -->
        <section id="step2">
            <h2><span class="step-number">2</span> The Log-Squared Likelihood Gradient</h2>

            <div class="problem-box">
                The exact Student-t likelihood gradient has a <strong>"volcano" shape</strong> ‚Äî it saturates at ¬±ŒΩ/2 for
                large deviations. When volatility is very wrong, particles feel the same gradient regardless of how wrong
                they are. This causes <strong>lag</strong>: particles can't catch up to rapid volatility changes.
            </div>

            <h3>The Volcano Problem Visualized</h3>
            
            <div class="diagram">
                <div class="diagram-title">Gradient Magnitude vs. Distance from True h</div>
                <svg viewBox="0 0 500 200" style="max-width: 500px; margin: 0 auto; display: block;">
                    <!-- Axes -->
                    <line x1="50" y1="150" x2="450" y2="150" stroke="#30363d" stroke-width="2"/>
                    <line x1="250" y1="20" x2="250" y2="150" stroke="#30363d" stroke-width="2"/>
                    
                    <!-- Student-t gradient (volcano) -->
                    <path d="M 50 150 Q 100 150, 150 80 Q 180 40, 200 35 L 200 35 Q 220 35, 250 30 Q 280 35, 300 35 Q 320 40, 350 80 Q 400 150, 450 150" 
                          fill="none" stroke="#f85149" stroke-width="3"/>
                    <text x="380" y="100" fill="#f85149" font-size="12">Student-t (saturates)</text>
                    
                    <!-- Log-squared gradient (linear) -->
                    <path d="M 50 150 L 250 30 L 450 150" fill="none" stroke="#3fb950" stroke-width="3"/>
                    <text x="380" y="70" fill="#3fb950" font-size="12">Log-squared (linear)</text>
                    
                    <!-- Labels -->
                    <text x="250" y="170" fill="#8b949e" font-size="11" text-anchor="middle">h - h_true</text>
                    <text x="30" y="90" fill="#8b949e" font-size="11" transform="rotate(-90, 30, 90)">|gradient|</text>
                    
                    <!-- Saturation indicators -->
                    <line x1="100" y1="35" x2="400" y2="35" stroke="#f85149" stroke-width="1" stroke-dasharray="5,5"/>
                    <text x="420" y="38" fill="#f85149" font-size="10">ŒΩ/2</text>
                </svg>
            </div>

            <p>
                The Student-t gradient saturates because of its heavy tails. When a particle is far from the truth,
                the gradient stops increasing ‚Äî it's "maxed out" at ŒΩ/2. This is problematic in stochastic volatility
                where we need strong corrective forces during volatility spikes.
            </p>

            <h3>The Solution: Log-Squared Observation Model</h3>
            <p>
                Instead of working with <code>y ~ exp(h/2) ¬∑ Œ∑</code> directly, we transform to:
            </p>

            <div class="formula">
                <div class="formula-label">Log-Squared Observation Model</div>
                log(y¬≤) = h + log(Œ∑¬≤)
            </div>

            <p>
                This linearizes the observation! The gradient becomes:
            </p>

            <div class="formula">
                <div class="formula-label">Linear Gradient</div>
                ‚àÇ/‚àÇh [ -(log(y¬≤) - h - offset)¬≤ / (2R) ] = (log(y¬≤) - h - offset) / R
            </div>

            <p>
                where <code>offset ‚âà -1/ŒΩ</code> (the expected value of log(Œ∑¬≤) for Student-t) and 
                <code>R ‚âà 1.4</code> (the observation noise variance in log space, tuned empirically).
            </p>

            <div class="insight-box">
                The log-squared gradient is <strong>linear</strong> ‚Äî particles far from the truth feel a proportionally
                stronger pull. This eliminates the "volcano" saturation and allows rapid catch-up during volatility spikes.
            </div>

            <pre><span class="comment">// Log-squared gradient (linear restoring force)</span>
<span class="keyword">float</span> log_y2 = logf(y_t * y_t + <span class="number">1e-10f</span>);
<span class="keyword">float</span> offset = -<span class="number">1.0f</span> / nu;    <span class="comment">// E[log(Œ∑¬≤)] approximation</span>
<span class="keyword">float</span> R_noise = <span class="number">1.4f</span>;         <span class="comment">// Tuned observation noise variance</span>

<span class="comment">// Linear gradient: pulls h toward log(y¬≤) - offset</span>
grad_lik[i] = (log_y2 - h_i - offset) / R_noise;</pre>

            <div class="result-box">
                <div class="metric">
                    <div class="metric-value">0.46 ‚Üí 0.4509</div>
                    <div class="metric-label">After R_noise Tuning</div>
                </div>
                <div style="flex: 1;">
                    <p><strong>Impact:</strong> The log-squared gradient combined with R_noise tuning gave a modest but
                    meaningful improvement. More importantly, it eliminated the systematic lag problem that would have
                    compounded with other optimizations.</p>
                </div>
            </div>
        </section>

        <!-- Step 3: Newton-Stein -->
        <section id="step3">
            <h2><span class="step-number">3</span> Newton-Stein: Hessian Preconditioning</h2>

            <div class="problem-box">
                Standard SVGD performs <strong>gradient descent</strong> on the KL divergence, treating all directions equally.
                But the SV posterior has variable curvature ‚Äî sharp peaks in some regions, flat valleys in others.
                A fixed step size either overshoots in sharp regions or crawls in flat ones.
            </div>

            <h3>From Gradient Descent to Newton's Method</h3>
            <p>
                The key insight from the supervisor: instead of moving particles along the gradient ‚àálog p, 
                move them along <code>H‚Åª¬π ¬∑ ‚àálog p</code>, where H is the Hessian (second derivative) of the log-posterior.
            </p>

            <div class="formula">
                <div class="formula-label">Standard SVGD Transport</div>
                œÜ(x) = (1/n) Œ£‚±º [ K(x,x‚±º) ¬∑ ‚àálog p(x‚±º) + ‚àá‚ÇìK(x,x‚±º) ]
            </div>

            <div class="formula">
                <div class="formula-label">Newton-Stein Transport</div>
                œÜ(x) = (1/n) Œ£‚±º [ K(x,x‚±º) ¬∑ H‚Åª¬π‚±º ¬∑ ‚àálog p(x‚±º) + ‚àá‚ÇìK(x,x‚±º) ¬∑ H‚Åª¬π‚±º ]
            </div>

            <h3>Adaptive Step Sizes</h3>
            <div class="comparison">
                <div class="comparison-item" style="border-color: var(--accent-orange);">
                    <h4 style="color: var(--accent-orange);">üèîÔ∏è Sharp Peak (High Curvature)</h4>
                    <p>H is large ‚Üí H‚Åª¬π is small</p>
                    <p><strong>Effect:</strong> Step size decreases, preventing overshooting</p>
                    <p>Repulsion weakens ‚Äî particles stay near the peak</p>
                </div>
                <div class="comparison-item" style="border-color: var(--accent-blue);">
                    <h4 style="color: var(--accent-blue);">üèúÔ∏è Flat Region (Low Curvature)</h4>
                    <p>H is small ‚Üí H‚Åª¬π is large</p>
                    <p><strong>Effect:</strong> Step size increases, faster convergence</p>
                    <p>Repulsion strengthens ‚Äî particles spread out</p>
                </div>
            </div>

            <h3>Computing the Hessian</h3>
            <p>For our 1D SV model with Student-t likelihood, let A = y¬≤/(ŒΩ¬∑exp(h)):</p>

            <div class="formula">
                <div class="formula-label">Likelihood Hessian</div>
                H_lik = -0.5 ¬∑ (ŒΩ+1) ¬∑ A / (1+A)¬≤ &nbsp;&nbsp; (negative = concave)
            </div>

            <div class="formula">
                <div class="formula-label">Prior Hessian</div>
                H_prior = -1 / œÉ_z¬≤ &nbsp;&nbsp; (constant curvature)
            </div>

            <pre><span class="comment">// Compute curvature (make positive for Newton step)</span>
<span class="keyword">float</span> A = y_sq / (nu * vol + <span class="number">1e-8f</span>);
<span class="keyword">float</span> one_plus_A = <span class="number">1.0f</span> + A;

<span class="keyword">float</span> hess_lik = -<span class="number">0.5f</span> * (nu + <span class="number">1.0f</span>) * (A / (one_plus_A * one_plus_A));
<span class="keyword">float</span> hess_prior = -<span class="number">1.0f</span> / sigma_z_sq;

<span class="keyword">float</span> curvature = -(hess_lik + hess_prior);  <span class="comment">// Make positive</span>
curvature = fmaxf(curvature, <span class="number">0.1f</span>);          <span class="comment">// Prevent explosion</span>
curvature = fminf(curvature, <span class="number">100.0f</span>);        <span class="comment">// Prevent vanishing</span>

<span class="keyword">float</span> inv_H = <span class="number">1.0f</span> / curvature;
precond_grad[i] = <span class="number">0.7f</span> * grad[i] * inv_H;    <span class="comment">// Damped Newton step</span></pre>

            <div class="result-box">
                <div class="metric">
                    <div class="metric-value">Better Hard Cases</div>
                    <div class="metric-label">Stress Ramp: -1.6%</div>
                </div>
                <div style="flex: 1;">
                    <p><strong>Trade-off:</strong> Newton-Stein slightly increased OU-Matched RMSE (+1%) but improved
                    Stress Ramp (-1.6%) and Spike+Recovery (-3.8%). The bias improved significantly, showing the
                    math is working correctly.</p>
                </div>
            </div>
        </section>

        <!-- Step 4: Guided Prediction -->
        <section id="step4">
            <h2><span class="step-number">4</span> Innovation-Gated Guided Prediction</h2>

            <div class="problem-box">
                Standard particle filters are <strong>reactive</strong>: they scatter particles blindly based on history
                (h_{t-1}), then use the current observation (y_t) to correct them. In high-volatility jumps, the blind
                scatter simply doesn't reach the new high-vol region ‚Äî there are no good particles to "correct."
                This causes <strong>lag</strong>.
            </div>

            <h3>The Big Idea: Proactive Prediction</h3>
            <p>
                Instead of blindly predicting from history, we <strong>peek</strong> at today's observation to guide
                where particles should go:
            </p>

            <div class="formula">
                <div class="formula-label">Standard Predict (Reactive)</div>
                h_t ~ N(Œº_prior, œÉ¬≤) &nbsp;&nbsp; where Œº_prior = Œº + œÅ(h_{t-1} - Œº)
            </div>

            <div class="formula">
                <div class="formula-label">Guided Predict (Proactive)</div>
                h_t ~ N((1-Œ±)¬∑Œº_prior + Œ±¬∑Œº_implied, œÉ¬≤) &nbsp;&nbsp; where Œº_implied = log(y_t¬≤) + 1.27
            </div>

            <div class="diagram">
                <div class="diagram-title">Standard vs Guided Prediction</div>
                <div class="flow-diagram">
                    <div class="flow-box" style="border-color: var(--accent-red);">
                        <strong>Standard</strong><br>
                        h_{t-1} ‚Üí Predict ‚Üí Scatter blindly ‚Üí Miss spike
                    </div>
                    <div class="flow-arrow">vs</div>
                    <div class="flow-box" style="border-color: var(--accent-green);">
                        <strong>Guided</strong><br>
                        h_{t-1} + y_t ‚Üí Predict ‚Üí Land near spike ‚Üí Stein refines
                    </div>
                </div>
            </div>

            <h3>The Critical Fix: Innovation Gating (Not Magnitude Gating)</h3>
            
            <p>
                Our first attempt gated Œ± on the <strong>magnitude</strong> of the return |y_t|. This failed badly ‚Äî
                in OU-Matched scenarios, high volatility is <em>expected</em>, but we were treating it as a shock.
            </p>

            <div class="insight-box">
                <strong>The key insight:</strong> Gate on <strong>surprise</strong> (innovation), not magnitude.
                Innovation = |implied_mean - prior_mean|. Only activate the guide when the model is <em>wrong</em>,
                not when volatility is merely <em>high</em>.
            </div>

            <div class="comparison">
                <div class="comparison-item wrong">
                    <h4>‚ùå Magnitude Gating (Failed)</h4>
                    <pre><span class="keyword">float</span> shock = fabsf(y_curr);
<span class="keyword">if</span> (shock > threshold) {
    alpha = alpha_shock;  <span class="comment">// WRONG!</span>
}</pre>
                    <p>Problem: High vol is "normal" in OU-Matched. Triggers on expected behavior.</p>
                </div>
                <div class="comparison-item correct">
                    <h4>‚úÖ Innovation Gating (Works)</h4>
                    <pre><span class="keyword">float</span> innovation = mean_implied - mean_prior;
<span class="keyword">float</span> z_score = innovation / total_std;
<span class="keyword">if</span> (z_score > threshold) {
    alpha = alpha_shock;  <span class="comment">// Only when surprised</span>
}</pre>
                    <p>Only triggers when observation disagrees with prediction.</p>
                </div>
            </div>

            <h3>The Zero-Return Trap</h3>
            <p>
                Even with innovation gating, we hit another bug: when y ‚âà 0 (a random normal event), log(y¬≤) ‚Üí -‚àû,
                creating a massive fake "innovation" that crashed the filter.
            </p>

            <div class="problem-box">
                When y_t ‚âà 0: log(y¬≤) ‚âà -20 ‚Üí innovation = |-20 - (-3)| = 17 ‚Üí massive "surprise" ‚Üí guide activates ‚Üí 
                particles teleported to vol ‚âà 0 ‚Üí <strong>CRASH</strong>
            </div>

            <div class="solution-box">
                Two safety fixes:
                <ol style="margin-left: 1.5rem; margin-top: 0.5rem;">
                    <li><strong>Bottom Clamp:</strong> <code>mean_implied = fmaxf(log_y2 + 1.27, -5.0)</code></li>
                    <li><strong>Asymmetric Gating:</strong> Only trigger on <em>positive</em> innovation (upward spikes).
                        Negative innovation (zero returns) ‚Üí trust the prior's mean reversion.</li>
                </ol>
            </div>

            <pre><span class="comment">// SAFETY FIX 1: Bottom clamp prevents log(0) ‚Üí -inf</span>
<span class="keyword">float</span> mean_implied = fmaxf(log_y2 + <span class="number">1.27f</span>, -<span class="number">5.0f</span>);

<span class="comment">// SAFETY FIX 2: Asymmetric gating - only help on UPWARD spikes</span>
<span class="keyword">float</span> innovation = mean_implied - mean_prior;  <span class="comment">// SIGNED, not absolute!</span>
<span class="keyword">float</span> z_score = innovation / total_std;

<span class="keyword">float</span> activation = <span class="number">0.0f</span>;
<span class="keyword">if</span> (z_score > innovation_threshold) {  <span class="comment">// Only positive z-scores!</span>
    activation = tanhf(z_score - innovation_threshold);
}
<span class="comment">// Negative z-score ‚Üí activation stays 0 ‚Üí pure prior</span></pre>

            <div class="result-box">
                <div class="metric">
                    <div class="metric-value">0.4489 ‚Üí 0.4332</div>
                    <div class="metric-label">OU-Matched RMSE</div>
                </div>
                <div class="metric">
                    <div class="metric-value">0.0019</div>
                    <div class="metric-label">Bias (near zero!)</div>
                </div>
                <div style="flex: 1;">
                    <p><strong>Impact:</strong> Innovation-gated guided prediction with safety fixes achieved our best
                    result: 0.4332 RMSE with essentially zero bias. The filter now helps on genuine surprises and stays
                    quiet otherwise.</p>
                </div>
            </div>
        </section>

        <!-- Other Enhancements -->
        <section id="other">
            <h2><span class="step-number">+</span> Other Enhancements</h2>

            <p>Several other techniques contributed to the final result:</p>

            <div class="summary-grid">
                <div class="summary-card">
                    <div class="label">Particle-Local Parameters</div>
                    <div class="value" style="font-size: 1rem;">Œ¥œÅ, Œ¥œÉ based on h deviation</div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Mimics z-dependent dynamics without knowing z
                    </p>
                </div>
                <div class="summary-card">
                    <div class="label">Asymmetric Persistence</div>
                    <div class="value" style="font-size: 1rem;">œÅ_up=0.99, œÅ_down=0.91</div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Vol spikes fast, decays slow (matches market behavior)
                    </p>
                </div>
                <div class="summary-card">
                    <div class="label">MIM Predict</div>
                    <div class="value" style="font-size: 1rem;">5% jump, 5x scale</div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Mixture innovation for fat-tailed transitions
                    </p>
                </div>
                <div class="summary-card">
                    <div class="label">SVLD Transport</div>
                    <div class="value" style="font-size: 1rem;">RMSProp + Langevin</div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Adaptive step sizes + diffusion for diversity
                    </p>
                </div>
                <div class="summary-card">
                    <div class="label">Annealed Stein</div>
                    <div class="value" style="font-size: 1rem;">Œ≤: 0.3 ‚Üí 0.65 ‚Üí 1.0</div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Gradual commitment to likelihood
                    </p>
                </div>
                <div class="summary-card">
                    <div class="label">Variance-Preserving Guide</div>
                    <div class="value" style="font-size: 1rem;">Shift, don't shrink</div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        EKF guide translates cloud, preserves spread
                    </p>
                </div>
            </div>
        </section>

        <!-- Final Results -->
        <section id="results">
            <h2>üìä Final Results</h2>

            <table>
                <thead>
                    <tr>
                        <th>Scenario</th>
                        <th>Original SVPF</th>
                        <th>Final SVPF</th>
                        <th>Improvement</th>
                        <th>Bias</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>OU-Matched</strong></td>
                        <td>0.68</td>
                        <td><strong>0.4332</strong></td>
                        <td class="improvement-positive">-36%</td>
                        <td>0.0019</td>
                    </tr>
                    <tr>
                        <td>Slow Drift</td>
                        <td>1.00+</td>
                        <td><strong>0.8410</strong></td>
                        <td class="improvement-positive">-16%</td>
                        <td>-0.5497</td>
                    </tr>
                    <tr>
                        <td>Stress Ramp</td>
                        <td>1.13</td>
                        <td><strong>0.9325</strong></td>
                        <td class="improvement-positive">-17%</td>
                        <td>-0.6178</td>
                    </tr>
                    <tr>
                        <td>Intermediate Band</td>
                        <td>1.11</td>
                        <td><strong>0.9266</strong></td>
                        <td class="improvement-positive">-17%</td>
                        <td>-0.6692</td>
                    </tr>
                    <tr>
                        <td>Spike+Recovery</td>
                        <td>0.60</td>
                        <td><strong>0.5323</strong></td>
                        <td class="improvement-positive">-11%</td>
                        <td>-0.1595</td>
                    </tr>
                    <tr>
                        <td>Wrong-Model</td>
                        <td>‚Äî</td>
                        <td><strong>0.7973</strong></td>
                        <td>‚Äî</td>
                        <td>-0.5616</td>
                    </tr>
                </tbody>
            </table>

            <div class="card" style="border-color: var(--accent-green); background: rgba(63, 185, 80, 0.1);">
                <div class="card-header" style="color: var(--accent-green);">üéØ Gap to HCRBPF Closed</div>
                <div style="display: flex; justify-content: space-around; text-align: center; margin: 1rem 0;">
                    <div>
                        <div style="font-size: 2rem; color: var(--accent-red);">66%</div>
                        <div style="color: var(--text-secondary);">Starting Gap</div>
                    </div>
                    <div style="font-size: 2rem; color: var(--text-secondary);">‚Üí</div>
                    <div>
                        <div style="font-size: 2rem; color: var(--accent-green);">5.7%</div>
                        <div style="color: var(--text-secondary);">Final Gap</div>
                    </div>
                </div>
                <p style="text-align: center;">
                    HCRBPF: 0.41 RMSE &nbsp;|&nbsp; SVPF: 0.4332 RMSE
                </p>
                <p style="text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                    The remaining ~6% gap is the irreducible cost of model misspecification ‚Äî HCRBPF knows the exact
                    z‚Üíparam mapping, while SVPF must infer everything from observations alone.
                </p>
            </div>
        </section>

        <!-- Journey Timeline -->
        <section id="timeline">
            <h2>üìà The Optimization Journey</h2>

            <div class="timeline">
                <div class="timeline-item">
                    <div class="time">Starting Point</div>
                    <div class="title">Wrong Per-Particle Prior</div>
                    <div class="result">RMSE: 0.68 | Gap: 66%</div>
                </div>
                <div class="timeline-item">
                    <div class="time">Fix #1</div>
                    <div class="title">O(N¬≤) Mixture Prior Gradient</div>
                    <div class="result">RMSE: 0.46 | Gap: 12%</div>
                </div>
                <div class="timeline-item">
                    <div class="time">Fix #2</div>
                    <div class="title">Log-Squared Likelihood + R_noise Tuning</div>
                    <div class="result">RMSE: 0.4509 | Gap: 10%</div>
                </div>
                <div class="timeline-item">
                    <div class="time">Enhancement #1</div>
                    <div class="title">Particle-Local Parameters</div>
                    <div class="result">RMSE: 0.4470 | Gap: 9%</div>
                </div>
                <div class="timeline-item">
                    <div class="time">Enhancement #2</div>
                    <div class="title">Newton-Stein (Hessian Preconditioning)</div>
                    <div class="result">RMSE: 0.4489 | Better bias, better hard cases</div>
                </div>
                <div class="timeline-item">
                    <div class="time">Enhancement #3</div>
                    <div class="title">Innovation-Gated Guided Prediction</div>
                    <div class="result">RMSE: 0.4332 | Gap: 5.7% | Bias: 0.0019</div>
                </div>
            </div>
        </section>

        <!-- Key Takeaways -->
        <section id="takeaways">
            <h2>üîë Key Takeaways</h2>

            <div class="card">
                <h3 style="margin-top: 0;">1. Mathematical Correctness First</h3>
                <p>
                    The biggest single improvement (66% ‚Üí 12% gap) came from fixing the mixture prior gradient to match
                    the paper's Equation 6. No amount of hyperparameter tuning can fix a fundamentally wrong algorithm.
                    Always verify your implementation against the source paper.
                </p>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">2. Understand the Failure Modes</h3>
                <p>
                    The "volcano" gradient saturation, the zero-return trap, and the magnitude-vs-innovation gating issue
                    were all subtle bugs that required understanding the <em>physics</em> of the problem. Stochastic
                    volatility has specific failure modes (lag during spikes, noise during calm periods) that require
                    targeted solutions.
                </p>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">3. Safety Constraints are Not Optional</h3>
                <p>
                    The bottom clamp (<code>fmaxf(..., -5.0)</code>) and asymmetric gating weren't elegant mathematical
                    insights ‚Äî they were practical safeguards that prevented catastrophic failures. Production code
                    needs these guardrails.
                </p>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">4. Test on Diverse Scenarios</h3>
                <p>
                    Optimizing for one scenario (OU-Matched) while ignoring others led to the magnitude-gating disaster.
                    The final solution works well across all scenarios because we tested holistically and fixed problems
                    as they appeared.
                </p>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">5. Model Misspecification Has Limits</h3>
                <p>
                    The remaining 5.7% gap is real ‚Äî SVPF assumes fixed parameters, but the true DGP has z-dependent
                    parameters. No amount of engineering can fully close this gap without either: (a) adding z to
                    SVPF's state, or (b) making parameters adaptive. This is the honest limit of what we can achieve.
                </p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="pizza-celebration">üçï</div>
            <p style="margin-top: 1rem;">
                <strong>Pizza earned.</strong><br>
                GPU heatsinks ready for New Haven style.
            </p>
            <p style="margin-top: 1rem; font-size: 0.9rem;">
                SVPF Optimization Journey | January 2026<br>
                Closing the gap from 66% to 5.7% through principled mathematical fixes
            </p>
        </footer>
    </div>

    <script>
        // Add some interactivity
        document.querySelectorAll('.toggle-details').forEach(button => {
            button.addEventListener('click', () => {
                const content = button.nextElementSibling;
                content.classList.toggle('open');
                button.textContent = content.classList.contains('open') ? '‚ñº Hide Details' : '‚ñ∂ Show Details';
            });
        });

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });
    </script>
</body>
</html>
